# Overview

This document will get you up and running with a ERC-721 asset contract on IMX. It's broken down into 3 key steps.
1. Deploy your smart contract to Ethereum
2. Configure your smart contract on IMX
3. Mint your tokens on IMX

> **Note**
> At various points throughout this lab you are asked to make changes to your `.env` file. Keep in mind after every such change you will need to save the file before running the next step.

# Requirements

### Nodejs & npm
You will need npm and nodejs installed in order to complete this tutorial. If you haven't already you can learn about installing npm [here.](https://docs.npmjs.com/downloading-and-installing-node-js-and-npm)

### Code editor
To edit the code, you'll need an IDE, and we recommend using Visual Studio Code, which you can download by following the instructions provided [here.](https://code.visualstudio.com/)

# Deploy your smart contract

## 1. Install the dependencies 
Install of the dependencies that this lab needs to run.

```sh
npm install
``` 

## 2. Copy env file
Make a copy of the `.env.example` file and rename the file to `.env`.

```sh
npm run copy-env
```

## 3. Setup your Ethereum account
In order to complete this tutorial you will need a valid Ethereum account that consists of an `address` and `private key`. If you are not comfortable with using one of your existing accounts you can easily create one with the command below. To ensure the security of your private key, it's crucial to store it using best practices such as utilizing a password-protected digital key wallet, keeping the key offline, backing up the key, and keeping it secret.

```sh
npm run generate-new-eth-account
```
Add them to the `.env`
- `CONTRACT_OWNER_ADDRESS`
- `OWNER_ACCOUNT_PRIVATE_KEY`

## 4. Setup provider API keys

### Etherscan
You need an Etherscan API key so that you can verify your contract after it has been deployed. Verifying a contract means making its source code public, along with the compiler settings you used, which allows anyone to compile it and compare the generated bytecode with the one that is deployed on-chain.

To get an API key from Etherscan you need to, [go to their site](https://etherscan.io/myapikey), sign in (or create an account if you don't have one) and open the "API Keys" tab. Then click the "Add" button and give a name to the API key you are creating. After that you'll see the newly created key in the list. Then add it to the `.env` file.
- `ETHERSCAN_API_KEY={API_KEY}`

### Alchemy
You will need an Alchemy API key in order to deploy your contract to the Ethereum Goerli testnet. We use Alchemy to communicate with the Ethereum chain without having to run our own nodes. You will need to make an account with [Alchemy](https://dashboard.alchemy.com/) and get an API key. Then add it to the `.env` file.
- `ALCHEMY_API_KEY={API_KEY}`

## 5. Update contract details
[Optional] Update the name and the symbol of the contract in the `.env` file before you deploy. 

- `CONTRACT_NAME`
- `CONTRACT_SYMBOL`


## 6. Get some Goerli ETH
To deploy your smart contract to the Goerli testnet you will need to add some Goerli ETH to your account to pay gas fees. You can do this using a faucet that has been setup by Alchemy: 

[https://goerlifaucet.com/](https://goerlifaucet.com/). 

Note: In order to receive Goerli ETH from this faucet you will need to login to the Alchemy account that you created in the previous step.

As demand for Goerli Eth can fluctuate, it's possible that the faucets may only be able to offer minimal amounts at times. Here are a couple of other faucets available that you can use instead:
* https://goerli-faucet.pk910.de/ 
* https://bigoerlifaucet.com/


## 7. Deploy the contract
Under the hood the command below will use Hardhat to deploy an ImmutableX compatible ERC-721 contract to the Goerli testnet.
```sh
npm run deploy-contract
```

## 8. Update env with contract address
Copy the `Deployed Contract Address` contract address from the console from the previous step you completed and add it to the `.env`:
- `CONTRACT_ADDRESS={CONTRACT_ADDRESS}`

# Setup your Smart contract in IMX

## 1. Register as a user with ImmutableX

ImmutableX provides an authentication service to protect your administrative level assets from being accessed or updated by someone else. This is done using your ETH private key using a similar technique as described [here](https://link.medium.com/CVTcj7YfQkb).

In order to use services like creating a project or collection, you will first need to register as an ImmutableX user. This is done by setting up an account using the private key from the wallet account you would like to specify as the owner of the project.

Run the following script:

```sh
npm run user-registration
```

## 2. Sign up to the developer Hub

To be able to create projects on ImmutableX, you first need to signup to [Immutable's developer hub](http://hub.immutable.com).

## 3. Create project

Update the values in the `.env` file with the values of the project you want to create.

- `PROJECT_NAME`
- `PROJECT_COMPANY_NAME`
- `PROJECT_EMAIL` (This must be the same email that you used above)

Once updated, run the following script to create your project:

```sh
npm run create-project
```

On completion, the script will log the PROJECT_ID of the created project. Save this `PROJECT_ID` in your .env file:
- `PROJECT_ID={PROJECT_ID}`

## 3. Add a collection

A collection refers to the smart contract that you have deployed. Minted assets belong to a collection. In order to mint assets on ImmutableX
you must first register your collection (smart contract) with ImmutableX.

Update the values in the `.env` file with the values of the collection you want to create.

- `COLLECTION_NAME`
- `COLLECTION_DESCRIPTION`
- `COLLECTION_ICON_URL`
- `COLLECTION_IMAGE_URL`


```sh
npm run create-collection
```

If you see a `replacement transaction underpriced` error message when trying to run `create-collection` please try again in 5 minutes.

# Minting assets

Next, we will mint a token on ImmutableX to the wallet address that you specify in the command. To view the NFT you will need to navigate to the [ImmutableX sandbox marketplace](https://market.sandbox.immutable.com/) and login with the wallet that you sent the NFT to. From there you will need to click my assets.

It is worth noting that you can only send ImmutableX NFTs to wallets that are registered with ImmutableX. The wallet you used to do this tutorial was registered above.

Firstly, set the `TOKEN_ID` in the `.env` to the latest incremented index for your contract.

Then to mint the token:

```sh
npm run mint -- -w <TO_WALLET_ADDRESS>
```

**-w** - _the wallet you wish to mint your NFTs to, e.g. the wallet you created and stored in `OWNER_ACCOUNT_ADDRESS` within .env_

Once you've minted your asset you can view it on the ImmutableX Marketplace via:

```
https://market.sandbox.immutable.com/inventory/assets/{contractAddress}/{tokenId}
```

---

# NFT metadata

## 1. Setup NFT.Storage API Key

We will be leveraging NFT.Storage to upload our metadata to the IPFS but to do this first we will need to get an API Key.

To get an API key from NFT.Storage you need to, [go to their site](https://nft.storage), sign in (or create an account if you don't have one) and select the "API Keys" menu item. Then click the "+ New Key" button and give a name to the API key you are creating. After that you'll see the newly created key in the list. Then add it to the `.env` file.
- `NFT_STORAGE_TOKEN={API_KEY}`

## 2. Upload the metadata

Optionally before you upload the metadata feel free to edit it. The metadata for our collection in the directory `metadata/data`. Each file has a corresponding image in the `metadata/images` directory. You may edit these values but make sure you follow our naming convention otherwise you may need to edit our uploading script.

We have a scrict in `metadata/1-upload-metadata` that uses `nft.storage` to deploy an our metadata to the IPFS.

```sh
npm run upload-metadata
```
On completion, the script will log the Gateway URL for the metadata uploaded to the IPFS. Save this as your `CONTRACT_METADATA_URI` in your .env file:
- `CONTRACT_METADATA_URI={Gateway url}`

## 3. Deploy a new contract and setup a collection

If you have **not** completed the previous lab and setup your environment and registered a project with ImmutableX you can follow these steps to go through the whole process:

[Deploy your smart contract](#deploy-your-smart-contract)

[Setup your Smart contract in IMX](#setup-your-smart-contract-in-imx)

Now we need to deploy a new smart contract and register it as a collection with ImmutableX. If you did the previous labs and you have already registered a project with ImmutableX and your .env value contains all the necessary values you can simply do the following:

[Optional] Update the name and the symbol of the contract in the `.env` file before you deploy. 

- `CONTRACT_NAME`
- `CONTRACT_SYMBOL`

```sh
npm run deploy-contract
```

Copy the `Deployed Contract Address` contract address from the console from the previous step you completed and add it to the `.env`:
- `CONTRACT_ADDRESS={CONTRACT_ADDRESS}`

Update the values in the `.env` file with the values of the collection you want to create.

- `COLLECTION_NAME`
- `COLLECTION_DESCRIPTION`
- `COLLECTION_ICON_URL`
- `COLLECTION_IMAGE_URL`


```sh
npm run create-collection
```

## 4. Add a metadata schema to the collection

A metadata schema allows services to query and filter your ImmutableX collection by metadata values. If you updated the metadata before you uploaded it before you may want to edit the schema in `metadata/4-add-metadata-schema`. Otherwise you may run this command

```sh
npm run add-metadata-schema
```

## 5. Mint your NFT!

Next, we will mint a token on ImmutableX to the wallet address that you specify in the command. To view the NFT you will need to navigate to the [ImmutableX sandbox marketplace](https://market.sandbox.immutable.com/) and login with the wallet that you sent the NFT to. From there you will need to click my assets.

It is worth noting that you can only send ImmutableX NFTs to wallets that are registered with ImmutableX. The wallet you used to do this tutorial was registered above.

Firstly, set the `TOKEN_ID` in the `.env` to the latest incremented index for your contract.

Then to mint the token:

```sh
npm run mint -- -w <TO_WALLET_ADDRESS>
```

**-w** - _the wallet you wish to mint your NFTs to, e.g. the wallet you created and stored in `OWNER_ACCOUNT_ADDRESS` within .env_

Once you've minted your asset you can view it on the ImmutableX Marketplace via:

```
https://market.sandbox.immutable.com/inventory/assets/{contractAddress}/{tokenId}
```

---

## Common Errors
```
Error: insufficient funds for intrinsic transaction cost [ See: https://links.ethers.org/v5-errors-INSUFFICIENT_FUNDS ] (error={"name":"ProviderError","code":-32000,"_isProviderError":true}, 
...
 {
  reason: 'insufficient funds for intrinsic transaction cost',
  code: 'INSUFFICIENT_FUNDS',
  error: ProviderError: insufficient funds for gas * price + value
    ...
  method: 'sendTransaction',
  transaction: undefined
}
```

If you see this you need to add more ETH to your wallet via the faucet.